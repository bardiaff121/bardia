<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>پیام‌رسان تلگرام کلون</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Vazir Font (Persian) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .message-bubble {
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .app-h {
            height: 100vh;
            height: 100dvh;
        }
    </style>
</head>
<body class="text-gray-800 app-h overflow-hidden">

    <!-- Auth/Signup Screen (Default visible until checked otherwise) -->
    <div id="auth-screen" class="fixed inset-0 bg-white z-40 hidden flex flex-col items-center justify-center p-6 animate-fade-in">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
            <div class="bg-blue-500 p-8 text-center">
                <div class="w-24 h-24 bg-white rounded-full mx-auto mb-4 flex items-center justify-center text-blue-500 text-3xl overflow-hidden relative group cursor-pointer" onclick="document.getElementById('profile-upload').click()">
                    <img id="auth-preview-img" class="w-full h-full object-cover hidden" src="" alt="Profile">
                    <i id="auth-preview-icon" class="fas fa-camera"></i>
                    <div class="absolute inset-0 bg-black bg-opacity-30 hidden group-hover:flex items-center justify-center text-white text-xs">تغییر</div>
                </div>
                <h2 class="text-white text-2xl font-bold">خوش آمدید</h2>
                <p class="text-blue-100 text-sm mt-2">لطفا پروفایل خود را تکمیل کنید</p>
            </div>
            
            <div class="p-8 space-y-4">
                <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">نام نمایشی</label>
                    <input type="text" id="auth-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="مثلا: علی رضایی">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">آیدی (نام کاربری)</label>
                    <div class="relative">
                        <span class="absolute right-4 top-3 text-gray-400">@</span>
                        <input type="text" id="auth-username" class="w-full pr-8 pl-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="username">
                    </div>
                </div>

                <button onclick="completeSignup()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-md mt-4">
                    ورود به برنامه
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="hidden w-full h-full flex relative bg-white">
        
        <!-- Sidebar -->
        <div id="sidebar" class="w-full md:w-1/3 lg:w-1/4 h-full border-l border-gray-200 flex flex-col bg-white z-10">
            
            <!-- Sidebar Header -->
            <div class="p-4 bg-white border-b border-gray-100 flex justify-between items-center sticky top-0 z-20">
                <div class="flex items-center cursor-pointer" onclick="openSettings()">
                    <img id="header-avatar" src="" class="w-10 h-10 rounded-full object-cover border border-gray-200" alt="Avatar">
                    <div class="mr-3">
                        <h3 id="header-name" class="font-bold text-gray-800 text-sm">...</h3>
                        <p class="text-xs text-gray-500">آنلاین</p>
                    </div>
                </div>
                <button onclick="openSettings()" class="text-gray-400 hover:text-blue-500 transition">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="p-3 bg-white">
                <div class="relative">
                    <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                    <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="جستجو بر اساس آیدی..." class="w-full bg-gray-100 text-gray-700 rounded-full py-2 pr-10 pl-4 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-100 transition text-sm">
                </div>
            </div>

            <!-- Chat List -->
            <div id="chat-list" class="flex-1 overflow-y-auto pb-20">
                <!-- Public Group Item -->
                <div onclick="openChat('global_public_group', 'گروه عمومی', '', true)" class="flex items-center p-3 hover:bg-gray-50 cursor-pointer transition border-b border-gray-50">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xl flex-shrink-0">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="mr-3 flex-1 min-w-0">
                        <div class="flex justify-between items-baseline mb-1">
                            <h4 class="font-bold text-gray-800 truncate">گروه عمومی</h4>
                        </div>
                        <p class="text-xs text-gray-500 truncate">چت همگانی با همه اعضا</p>
                    </div>
                </div>
                
                <div id="search-results" class="hidden bg-yellow-50"></div>
                <div id="private-chats-container"></div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-area" class="fixed inset-0 md:static w-full md:w-2/3 lg:w-3/4 h-full bg-[#f3f4f6] flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 z-30">
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden md:flex w-full h-full flex-col items-center justify-center text-gray-400">
                <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4 text-4xl">
                    <i class="fas fa-paper-plane text-gray-400"></i>
                </div>
                <p>یک گفتگو را برای شروع انتخاب کنید</p>
            </div>

            <!-- Active Chat Interface -->
            <div id="active-chat-interface" class="flex flex-col h-full hidden">
                
                <!-- Chat Header -->
                <div class="bg-white p-3 border-b border-gray-200 flex items-center shadow-sm relative z-20">
                    <button onclick="closeChat()" class="md:hidden ml-3 text-gray-500 p-2 hover:bg-gray-100 rounded-full">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <!-- Chat Info (Clickable for Group Members) -->
                    <div id="chat-header-info" class="flex items-center flex-1 cursor-pointer hover:opacity-80 transition" onclick="handleHeaderClick()">
                        <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden flex-shrink-0">
                            <img id="chat-header-img" src="" class="w-full h-full object-cover hidden">
                            <div id="chat-header-icon" class="w-full h-full flex items-center justify-center bg-blue-500 text-white">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        <div class="mr-3">
                            <h3 id="chat-header-title" class="font-bold text-gray-800">نام چت</h3>
                            <p id="chat-header-status" class="text-xs text-blue-500">آنلاین</p>
                        </div>
                    </div>

                    <!-- Members Button (Only visible in group) -->
                    <button id="group-members-btn" onclick="showGroupMembers()" class="hidden text-blue-500 hover:bg-blue-50 p-2 rounded-full mr-2" title="لیست اعضا">
                        <i class="fas fa-users text-lg"></i>
                    </button>
                </div>

                <!-- Messages Container -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#e5e7eb] bg-opacity-50"></div>

                <!-- Input Area -->
                <div class="bg-white p-3 md:p-4 border-t border-gray-200">
                    <div class="flex items-end space-x-2 space-x-reverse bg-gray-100 rounded-2xl p-2">
                        <button class="p-2 text-gray-400 hover:text-gray-600 rounded-full">
                            <i class="fas fa-smile text-xl"></i>
                        </button>
                        <textarea id="message-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 resize-none py-2 px-2 max-h-32 text-sm" placeholder="پیام خود را بنویسید..."></textarea>
                        <button onclick="sendMessage()" class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-md transition transform active:scale-95 w-10 h-10 flex items-center justify-center">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Members Modal -->
    <div id="members-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end md:items-center justify-center">
        <div class="bg-white w-full md:w-96 md:rounded-2xl rounded-t-2xl h-[80vh] md:h-[600px] overflow-hidden flex flex-col shadow-2xl animate-fade-in">
            <div class="bg-gradient-to-l from-blue-500 to-blue-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg"><i class="fas fa-users ml-2"></i>اعضای گروه</h3>
                <button onclick="document.getElementById('members-modal').classList.add('hidden')">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-2 bg-blue-50 text-xs text-gray-600 text-center border-b border-blue-100">
                برای ارسال پیام خصوصی روی کاربر کلیک کنید
            </div>
            <div id="members-list" class="flex-1 overflow-y-auto p-0">
                <!-- Members injected here -->
                <div class="flex justify-center mt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end md:items-center justify-center">
        <div class="bg-white w-full md:w-96 md:rounded-2xl rounded-t-2xl h-[80vh] md:h-auto overflow-hidden flex flex-col shadow-2xl animate-fade-in">
            <div class="bg-blue-500 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg">تنظیمات</h3>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div class="flex flex-col items-center mb-6">
                    <div class="relative w-24 h-24 mb-3 cursor-pointer group" onclick="document.getElementById('settings-upload').click()">
                        <img id="settings-avatar" src="" class="w-full h-full rounded-full object-cover border-4 border-white shadow-md">
                        <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <input type="file" id="settings-upload" class="hidden" accept="image/*" onchange="handleSettingsImage(this)">
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold">نام نمایشی</label>
                        <input type="text" id="settings-name" class="w-full border-b border-gray-300 py-2 focus:border-blue-500 focus:outline-none bg-transparent">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold">آیدی (Username)</label>
                        <input type="text" id="settings-username" class="w-full border-b border-gray-300 py-2 focus:border-blue-500 focus:outline-none bg-transparent">
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full mt-8 bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-lg">
                    ذخیره تغییرات
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, onSnapshot, orderBy, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- State ---
        let currentUser = null;
        let userData = null;
        let currentChatId = null;
        let messageUnsubscribe = null;
        let base64ProfileImage = '';
        let isCurrentChatGroup = false;

        // --- Paths ---
        const getPublicCollection = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);
        const getPublicDoc = (colName, docId) => doc(db, 'artifacts', appId, 'public', 'data', colName, docId);

        // --- Auth (No Loading Screen) ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                // If error, show auth screen as fallback
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await checkUserProfile();
            } else {
                initAuth();
            }
        });

        async function checkUserProfile() {
            try {
                const userDocRef = getPublicDoc('users', currentUser.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    userData = docSnap.data();
                    loadMainInterface();
                } else {
                    // New User -> Show Auth Screen
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('auth-screen').classList.add('flex');
                    document.getElementById('main-app').classList.add('hidden');
                }
            } catch (error) {
                console.error("Profile check error:", error);
            }
        }

        // --- Main Interface ---
        function loadMainInterface() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Setup Header
            document.getElementById('header-name').innerText = userData.name;
            document.getElementById('header-avatar').src = userData.photoURL;
            
            // Settings Pre-fill
            document.getElementById('settings-name').value = userData.name;
            document.getElementById('settings-username').value = userData.username;
            document.getElementById('settings-avatar').src = userData.photoURL;
        }

        // --- Image Helpers ---
        window.handleImagePreview = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxSize = 200; 
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                        } else {
                            if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        base64ProfileImage = canvas.toDataURL('image/jpeg', 0.7);
                        
                        document.getElementById('auth-preview-img').src = base64ProfileImage;
                        document.getElementById('auth-preview-img').classList.remove('hidden');
                        document.getElementById('auth-preview-icon').classList.add('hidden');
                    };
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- Signup ---
        window.completeSignup = async () => {
            const name = document.getElementById('auth-name').value.trim();
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            
            if (!name || !username) { alert("لطفا نام و آیدی را وارد کنید."); return; }
            if (username.length < 4) { alert("آیدی باید حداقل ۴ کاراکتر باشد."); return; }

            const btn = document.querySelector('#auth-screen button');
            btn.innerText = 'لطفا صبر کنید...';
            btn.disabled = true;

            try {
                const q = query(getPublicCollection('users'), where('username', '==', username));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    alert("این آیدی قبلا گرفته شده است.");
                    btn.innerText = 'ورود به برنامه';
                    btn.disabled = false;
                    return;
                }

                const photoURL = base64ProfileImage || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff`;
                const newUserData = {
                    uid: currentUser.uid,
                    name: name,
                    username: username,
                    photoURL: photoURL,
                    createdAt: serverTimestamp(),
                    bio: 'کاربر جدید تلگرام'
                };

                await setDoc(getPublicDoc('users', currentUser.uid), newUserData);
                userData = newUserData;
                loadMainInterface();

            } catch (e) {
                console.error(e);
                alert("خطا در ثبت نام: " + e.message);
                btn.innerText = 'ورود به برنامه';
                btn.disabled = false;
            }
        };

        // --- Search ---
        let searchTimeout;
        window.handleSearch = () => {
            clearTimeout(searchTimeout);
            const queryText = document.getElementById('search-input').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (queryText.length === 0) {
                resultsDiv.classList.add('hidden');
                resultsDiv.innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                const q = query(getPublicCollection('users'), where('username', '>=', queryText), where('username', '<=', queryText + '\uf8ff'), limit(5));
                const snapshot = await getDocs(q);
                resultsDiv.innerHTML = '';
                
                if (snapshot.empty) {
                    resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-500 text-sm">کاربری یافت نشد</div>';
                } else {
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        if (user.uid === currentUser.uid) return;
                        renderUserItem(user, resultsDiv);
                    });
                }
                resultsDiv.classList.remove('hidden');
            }, 500);
        };

        function renderUserItem(user, container) {
            const el = document.createElement('div');
            el.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 transition';
            el.innerHTML = `
                <img src="${user.photoURL}" class="w-10 h-10 rounded-full object-cover ml-3">
                <div>
                    <h4 class="text-sm font-bold text-gray-800">${user.name}</h4>
                    <p class="text-xs text-blue-500">@${user.username}</p>
                </div>
            `;
            const chatId = [currentUser.uid, user.uid].sort().join('_');
            el.onclick = () => {
                openChat(chatId, user.name, user.photoURL, false);
                // Clear search if open
                const searchInput = document.getElementById('search-input');
                if(searchInput) searchInput.value = '';
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('members-modal').classList.add('hidden'); // Close modal if open
            };
            container.appendChild(el);
        }

        // --- Chat Logic ---
        window.openChat = (chatId, title, image, isGroup) => {
            currentChatId = chatId;
            isCurrentChatGroup = isGroup;
            
            // Header UI
            document.getElementById('chat-header-title').innerText = title;
            const imgEl = document.getElementById('chat-header-img');
            const iconEl = document.getElementById('chat-header-icon');
            const membersBtn = document.getElementById('group-members-btn');
            const statusEl = document.getElementById('chat-header-status');
            
            if (isGroup) {
                imgEl.classList.add('hidden');
                iconEl.classList.remove('hidden');
                iconEl.innerHTML = '<i class="fas fa-users"></i>';
                statusEl.innerText = 'کلیک برای لیست اعضا';
                membersBtn.classList.remove('hidden');
            } else {
                if(image) {
                    imgEl.src = image;
                    imgEl.classList.remove('hidden');
                    iconEl.classList.add('hidden');
                } else {
                    imgEl.classList.add('hidden');
                    iconEl.classList.remove('hidden');
                    iconEl.innerHTML = '<i class="fas fa-user"></i>';
                }
                statusEl.innerText = 'آنلاین';
                membersBtn.classList.add('hidden');
            }

            // Navigation
            document.getElementById('chat-area').classList.remove('translate-x-full');
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('active-chat-interface').classList.remove('hidden');
            document.getElementById('active-chat-interface').classList.add('flex');

            loadMessages(chatId);
        };

        window.closeChat = () => {
            document.getElementById('chat-area').classList.add('translate-x-full');
            document.getElementById('sidebar').classList.remove('hidden');
            currentChatId = null;
            if (messageUnsubscribe) messageUnsubscribe();
        };

        window.handleHeaderClick = () => {
            if (isCurrentChatGroup) {
                showGroupMembers();
            }
        };

        // --- Messages ---
        function loadMessages(chatId) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '<div class="text-center text-gray-400 mt-4 text-xs">در حال دریافت...</div>';
            if (messageUnsubscribe) messageUnsubscribe();

            const q = query(getPublicCollection('messages'), where('chatId', '==', chatId), orderBy('timestamp', 'asc'), limit(100));

            messageUnsubscribe = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center text-gray-400 mt-10 text-sm bg-gray-200 rounded-full py-1 px-4 mx-auto w-max">پیامی وجود ندارد. گفتگو را آغاز کنید!</div>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === currentUser.uid;
                    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'}) : '...';
                    
                    const div = document.createElement('div');
                    div.className = `flex w-full mb-2 ${isMe ? 'justify-end' : 'justify-start'}`;
                    div.innerHTML = `
                        <div class="message-bubble relative max-w-[80%] md:max-w-[70%] min-w-[80px] px-3 py-2 rounded-2xl text-sm ${
                            isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'
                        }">
                            ${!isMe ? `<div class="text-[10px] font-bold text-blue-500 mb-1 opacity-90">${msg.senderName}</div>` : ''}
                            <div class="pb-3 text-[14px] leading-6 whitespace-pre-wrap">${msg.text}</div>
                            <div class="absolute bottom-1 left-2 text-[10px] ${isMe ? 'text-blue-100' : 'text-gray-400'}">${time}</div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            }, (err) => console.log(err));
        }

        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
            input.value = '';
            try {
                await addDoc(getPublicCollection('messages'), {
                    text: text, senderId: currentUser.uid, senderName: userData.name, chatId: currentChatId, timestamp: serverTimestamp()
                });
            } catch (error) { console.error("Error sending message:", error); }
        };

        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });

        // --- Group Members Logic ---
        window.showGroupMembers = async () => {
            const modal = document.getElementById('members-modal');
            const list = document.getElementById('members-list');
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="flex justify-center mt-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>';

            try {
                // Fetch ALL users (For this scale it's fine)
                const q = query(getPublicCollection('users'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center p-4 text-gray-500">عضوی یافت نشد</div>';
                }

                snapshot.forEach(doc => {
                    const user = doc.data();
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 transition bg-white';
                    
                    // Style differently for current user
                    const isMe = user.uid === currentUser.uid;
                    const suffix = isMe ? ' (شما)' : '';
                    
                    div.innerHTML = `
                        <div class="relative">
                            <img src="${user.photoURL}" class="w-12 h-12 rounded-full object-cover ml-3 border border-gray-200">
                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-sm">${user.name} <span class="text-xs text-gray-400">${suffix}</span></h4>
                            <p class="text-xs text-blue-500">@${user.username}</p>
                        </div>
                        ${!isMe ? '<div class="text-gray-400"><i class="fas fa-comment-alt"></i></div>' : ''}
                    `;
                    
                    if (!isMe) {
                        const chatId = [currentUser.uid, user.uid].sort().join('_');
                        div.onclick = () => {
                            modal.classList.add('hidden');
                            openChat(chatId, user.name, user.photoURL, false);
                        };
                    }
                    
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = '<div class="text-center p-4 text-red-500">خطا در دریافت لیست اعضا</div>';
            }
        };

        // --- Settings Logic ---
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        
        window.handleSettingsImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                         const canvas = document.createElement('canvas');
                         const ctx = canvas.getContext('2d');
                         const maxSize = 200;
                         let w=img.width, h=img.height;
                         if(w>h){ if(w>maxSize){h*=maxSize/w; w=maxSize;}}
                         else{ if(h>maxSize){w*=maxSize/h; h=maxSize;}}
                         canvas.width=w; canvas.height=h;
                         ctx.drawImage(img,0,0,w,h);
                         const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                         document.getElementById('settings-avatar').src = dataUrl;
                         userData.tempPhoto = dataUrl;
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.saveSettings = async () => {
            const newName = document.getElementById('settings-name').value.trim();
            const newUsername = document.getElementById('settings-username').value.trim().toLowerCase();
            const newPhoto = userData.tempPhoto || userData.photoURL;

            if(!newName || !newUsername) { alert('نام و آیدی الزامی است'); return;}
            
            const btn = document.querySelector('#settings-modal button');
            const oldText = btn.innerText;
            btn.innerText = 'ذخیره...';
            btn.disabled = true;

            try {
                const updates = { name: newName, username: newUsername, photoURL: newPhoto };
                await updateDoc(getPublicDoc('users', currentUser.uid), updates);
                userData = { ...userData, ...updates };
                delete userData.tempPhoto;
                document.getElementById('header-name').innerText = newName;
                document.getElementById('header-avatar').src = newPhoto;
                document.getElementById('settings-modal').classList.add('hidden');
                alert('ذخیره شد');
            } catch (error) { console.error(error); alert('خطا'); } 
            finally { btn.innerText = oldText; btn.disabled = false; }
        };

    </script>
</body>
</html>


