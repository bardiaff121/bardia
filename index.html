<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† ÙØ§Ø±Ø³ÛŒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Vazir Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f3f4f6; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .message-bubble { max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .app-h { height: 100vh; height: 100dvh; }
        .chat-bg { background-color: #8e9aaf; background-image: url('https://web.telegram.org/img/bg_0.png'); background-size: cover; background-attachment: fixed; }
    </style>
</head>
<body class="text-gray-800 app-h overflow-hidden select-none bg-gray-50">

    <!-- 1. AUTH SCREEN (ÙˆØ±ÙˆØ¯/Ø«Ø¨Øª Ù†Ø§Ù…) -->
    <div id="auth-screen" class="fixed inset-0 bg-white z-50 hidden flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <div class="bg-blue-600 p-8 text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-blue-500 opacity-50 blur-xl"></div>
                <div class="relative z-10">
                    <div class="w-24 h-24 bg-white rounded-full mx-auto mb-4 flex items-center justify-center text-blue-500 relative group cursor-pointer shadow-lg ring-4 ring-blue-400/30" onclick="document.getElementById('profile-upload').click()">
                        <img id="auth-preview-img" class="w-full h-full rounded-full object-cover hidden" src="">
                        <i id="auth-preview-icon" class="fas fa-camera text-3xl"></i>
                    </div>
                    <h2 class="text-white text-2xl font-bold">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
                    <p class="text-blue-100 text-sm mt-2">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¹Ú©Ø³ Ùˆ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
                </div>
            </div>
            <div class="p-8 space-y-5">
                <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="handleImagePreview(this)">
                <div>
                    <label class="text-xs font-bold text-gray-500 mr-1 mb-1 block">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                    <input type="text" id="auth-name" class="w-full p-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none bg-gray-50 transition" placeholder="Ù…Ø«Ù„Ø§: Ø¹Ù„ÛŒ">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 mr-1 mb-1 block">Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)</label>
                    <div class="relative" dir="ltr">
                        <span class="absolute left-3 top-3.5 text-gray-400">@</span>
                        <input type="text" id="auth-username" class="w-full pl-8 p-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none bg-gray-50 transition text-left" placeholder="username">
                    </div>
                </div>
                <button onclick="completeSignup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition active:scale-95">Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ</button>
            </div>
        </div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="main-app" class="hidden w-full h-full flex relative bg-white">
        
        <!-- Sidebar (Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§) -->
        <div id="sidebar" class="w-full md:w-1/3 lg:w-1/4 h-full border-l border-gray-200 flex flex-col bg-white z-10">
            <!-- Header -->
            <div class="p-3 px-4 bg-white flex justify-between items-center sticky top-0 z-20">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-paper-plane"></i></div>
                    <div class="text-gray-800 font-bold text-lg">Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†</div>
                </div>
                <button onclick="openSettings()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-600 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Search -->
            <div class="px-4 pb-3">
                <div class="relative bg-gray-100 rounded-2xl overflow-hidden group focus-within:ring-2 focus-within:ring-blue-100 transition">
                    <i class="fas fa-search absolute right-4 top-3 text-gray-400 text-sm"></i>
                    <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†..." class="w-full bg-transparent py-2.5 pr-10 pl-4 text-sm focus:outline-none text-gray-700">
                </div>
            </div>

            <!-- List -->
            <div id="chat-list" class="flex-1 overflow-y-auto pb-20 space-y-1">
                <!-- Pinned Group -->
                <div onclick="openChat('global_public_group', 'Ú¯Ø±ÙˆÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ', '', true)" class="flex items-center p-3 mx-2 rounded-xl hover:bg-gray-50 cursor-pointer transition group">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-2xl shadow-sm shrink-0 group-hover:scale-105 transition">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="mr-3 flex-1 overflow-hidden">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-gray-800 truncate">Ú¯Ø±ÙˆÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ</h4>
                        </div>
                        <p class="text-xs text-gray-500 truncate">Ú†Øª Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø¨Ø§ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</p>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="search-results" class="hidden bg-blue-50 border-y border-blue-100 mx-2 rounded-lg mb-2 overflow-hidden"></div>
                
                <!-- Recent Chats Container -->
                <div id="recent-chats-list" class="mt-1">
                    <!-- Chats will be injected here -->
                    <div class="text-center text-xs text-gray-400 mt-10">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§...</div>
                </div>
            </div>
        </div>

        <!-- Chat Area (ØµÙØ­Ù‡ Ú†Øª) -->
        <div id="chat-area" class="fixed inset-0 md:static w-full md:w-2/3 lg:w-3/4 h-full chat-bg flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 z-30">
            
            <!-- Default Empty State -->
            <div id="empty-state" class="hidden md:flex w-full h-full items-center justify-center flex-col text-white">
                <div class="w-24 h-24 bg-black bg-opacity-20 rounded-full flex items-center justify-center mb-4 backdrop-blur-sm">
                    <i class="fas fa-comments text-4xl opacity-80"></i>
                </div>
                <div class="bg-black bg-opacity-20 px-6 py-2 rounded-full text-sm backdrop-blur-sm">
                    ÛŒÚ© Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="active-chat-interface" class="flex flex-col h-full hidden relative">
                
                <!-- Chat Header -->
                <div class="bg-white/95 backdrop-blur-md p-2 px-4 flex items-center shadow-sm z-20 cursor-pointer border-b border-gray-100" onclick="handleHeaderClick()">
                    <button onclick="closeChat()" class="md:hidden ml-2 text-gray-500 hover:bg-gray-100 p-2 rounded-full w-10 h-10 flex items-center justify-center transition"><i class="fas fa-arrow-right"></i></button>
                    
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden flex-shrink-0 border border-gray-100">
                            <img id="chat-header-img" src="" class="w-full h-full object-cover hidden">
                            <div id="chat-header-icon" class="w-full h-full flex items-center justify-center bg-blue-500 text-white"><i class="fas fa-user"></i></div>
                        </div>
                        <div class="mr-3 flex-1 min-w-0">
                            <h3 id="chat-header-title" class="font-bold text-gray-800 text-sm truncate">...</h3>
                            <p id="chat-header-status" class="text-[11px] text-blue-500 truncate">...</p>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-2 relative"></div>

                <!-- Input -->
                <div class="bg-white/95 backdrop-blur p-2 md:p-3 pb-safe">
                    <div class="flex items-end bg-gray-100 rounded-2xl p-1 border border-gray-200 focus-within:border-blue-400 focus-within:ring-2 focus-within:ring-blue-100 transition">
                        <textarea id="message-input" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 resize-none py-3 px-4 max-h-32 text-sm text-gray-800 placeholder-gray-400" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                        <button onclick="sendMessage()" class="p-3 mb-0.5 text-blue-500 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition transform active:scale-90"><i class="fas fa-paper-plane text-xl rtl:rotate-180"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Members Modal (Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª Ø§Ø¹Ø¶Ø§) -->
    <div id="members-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-2xl h-[70vh] flex flex-col shadow-2xl overflow-hidden animate-slide-up">
            <div class="bg-white p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700">Ø§Ø¹Ø¶Ø§ÛŒ Ú¯Ø±ÙˆÙ‡</h3>
                <button onclick="document.getElementById('members-modal').classList.add('hidden')" class="w-8 h-8 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="members-list" class="flex-1 overflow-y-auto p-2"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl animate-scale-in">
            <div class="bg-white p-4 border-b flex justify-between items-center">
                <h3 class="font-bold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h3>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 flex flex-col items-center">
                <div class="w-28 h-28 rounded-full bg-gray-200 mb-6 relative overflow-hidden group cursor-pointer shadow-lg" onclick="document.getElementById('set-upload').click()">
                    <img id="set-avatar" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition duration-300"><i class="fas fa-camera text-2xl"></i></div>
                </div>
                <input type="file" id="set-upload" class="hidden" onchange="handleSetImage(this)">
                
                <div class="w-full mb-4">
                    <label class="text-xs text-gray-500 mr-2 mb-1 block">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                    <input id="set-name" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none text-center font-bold">
                </div>
                
                <button onclick="saveSettings()" class="bg-blue-600 text-white w-full py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition active:scale-95">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, onSnapshot, orderBy, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ğŸ”¥ CONFIG (Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø¯ Firebase Ø®ÙˆØ¯Øª Ø±Ùˆ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡)
        const firebaseConfig = {
            apiKey: "AIzaSyAs_HguZ_up86aWIuQohq8nJl57aoE67Vo",
            authDomain: "hichat-597f0.firebaseapp.com",
            projectId: "hichat-597f0",
            storageBucket: "hichat-597f0.firebasestorage.app",
            messagingSenderId: "42057542840",
            appId: "1:42057542840:web:8f123beb76a1930fb5184d",
            measurementId: "G-BJRG0Y9TPY"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null, userData = null, currentChatId = null;
        let unsubscribeMsg = null, unsubscribeChats = null, tempImg = null, isGroup = false;

        // ğŸ”§ SIMPLE PATH (Ø¨Ø¯ÙˆÙ† artifacts)
        const pubCol = (n) => collection(db, n);
        const pubDoc = (n, id) => doc(db, n, id);

        // --- 1. AUTH LOGIC ---
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth Fail", e);
                showAuthScreen();
            }
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const snap = await getDoc(pubDoc('users', user.uid));
                    if (snap.exists()) {
                        userData = snap.data();
                        showMainApp();
                    } else {
                        showAuthScreen();
                    }
                } catch (e) { showAuthScreen(); }
            }
        });

        function showAuthScreen() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('auth-screen').classList.add('flex');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('flex');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('set-name').value = userData.name;
            document.getElementById('set-avatar').src = userData.photoURL;
            loadRecentChats();
        }

        // --- 2. SIGNUP ---
        window.handleImagePreview = (input) => processImage(input, (res) => {
            tempImg = res;
            document.getElementById('auth-preview-img').src = res;
            document.getElementById('auth-preview-img').classList.remove('hidden');
            document.getElementById('auth-preview-icon').classList.add('hidden');
        });

        window.completeSignup = async () => {
            const name = document.getElementById('auth-name').value.trim();
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            if(!name || !username) return alert('Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ø¢ÛŒØ¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            
            const btn = document.querySelector('#auth-screen button');
            const oldText = btn.innerText;
            btn.innerText = 'Ø¯Ø±Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨...';
            btn.disabled = true;
            
            try {
                // Check Username
                const q = query(pubCol('users'), where('username', '==', username));
                const snap = await getDocs(q);
                if (!snap.empty && snap.docs[0].id !== currentUser.uid) throw new Error('Ø§ÛŒÙ† Ø¢ÛŒØ¯ÛŒ Ù‚Ø¨Ù„Ø§ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª');

                const photoURL = tempImg || `https://ui-avatars.com/api/?name=${name}&background=3b82f6&color=fff`;
                const newUser = { uid: currentUser.uid, name, username, photoURL, createdAt: serverTimestamp(), bio: 'Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†' };
                
                await setDoc(pubDoc('users', currentUser.uid), newUser);
                userData = newUser;
                showMainApp();
            } catch (e) { alert(e.message); btn.innerText = oldText; btn.disabled = false; }
        };

        // --- 3. RECENT CHATS (Sidebar) ---
        function loadRecentChats() {
            if(unsubscribeChats) unsubscribeChats();
            const list = document.getElementById('recent-chats-list');
            
            const q = query(pubCol('chats'), where('participantIds', 'array-contains', currentUser.uid));
            
            unsubscribeChats = onSnapshot(q, (snap) => {
                const chats = [];
                snap.forEach(d => chats.push({id: d.id, ...d.data()}));
                
                // Sort by lastMessageTime descending (Newest first)
                chats.sort((a, b) => {
                    const ta = a.lastMessageTime?.seconds || 0;
                    const tb = b.lastMessageTime?.seconds || 0;
                    return tb - ta;
                });

                list.innerHTML = '';
                if(chats.length === 0) {
                    list.innerHTML = '<div class="text-center text-xs text-gray-400 mt-4">Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div>';
                }

                chats.forEach(chat => {
                    // Determine Other User Name/Photo
                    let title = "Ú¯Ø±ÙˆÙ‡";
                    let img = "";
                    let isPV = chat.type === 'private';
                    
                    if (isPV) {
                        const otherId = chat.participantIds.find(id => id !== currentUser.uid) || currentUser.uid;
                        const otherData = chat.participantsData?.[otherId] || {name: 'Ú©Ø§Ø±Ø¨Ø±', photo: ''};
                        title = otherData.name;
                        img = otherData.photo || `https://ui-avatars.com/api/?name=${title}&background=random`;
                    } else {
                        title = chat.title || "Ú¯Ø±ÙˆÙ‡";
                        img = chat.photo || ""; 
                    }

                    // Time Formatting
                    let timeStr = '';
                    if(chat.lastMessageTime) {
                        timeStr = new Date(chat.lastMessageTime.seconds * 1000).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
                    }

                    const div = document.createElement('div');
                    div.className = 'flex items-center p-3 mx-2 rounded-xl hover:bg-gray-50 cursor-pointer transition group relative';
                    div.onclick = () => openChat(chat.id, title, img, !isPV);
                    
                    div.innerHTML = `
                        <div class="relative">
                             <img src="${img}" class="w-14 h-14 rounded-full object-cover shadow-sm bg-gray-200">
                             ${!isPV ? '<div class="absolute -bottom-1 -right-1 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] border-2 border-white"><i class="fas fa-users"></i></div>' : ''}
                        </div>
                        <div class="mr-3 flex-1 overflow-hidden min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-bold text-gray-800 text-sm truncate">${title}</h4>
                                <span class="text-[10px] text-gray-400 shrink-0">${timeStr}</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate h-4">${chat.lastMessage || '...'}</p>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }, (error) => {
                console.error("Chat list error:", error);
                list.innerHTML = '<div class="text-center text-xs text-red-400 mt-4">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª</div>';
            });
        }

        // --- 4. CHAT AREA ---
        window.openChat = (chatId, title, img, group) => {
            currentChatId = chatId;
            isGroup = group;
            
            // Header UI
            document.getElementById('chat-header-title').innerText = title;
            const sEl = document.getElementById('chat-header-status');
            sEl.innerText = group ? 'Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø¹Ø¶Ø§ Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯' : 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
            
            if(group) {
                document.getElementById('chat-header-img').classList.add('hidden');
                document.getElementById('chat-header-icon').classList.remove('hidden');
                document.getElementById('chat-header-icon').innerHTML = '<i class="fas fa-users"></i>';
            } else {
                document.getElementById('chat-header-img').src = img;
                document.getElementById('chat-header-img').classList.remove('hidden');
                document.getElementById('chat-header-icon').classList.add('hidden');
            }

            // Slide In
            document.getElementById('chat-area').classList.remove('translate-x-full');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('active-chat-interface').classList.remove('hidden');
            document.getElementById('active-chat-interface').classList.add('flex');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');

            // Load Messages
            if(unsubscribeMsg) unsubscribeMsg();
            
            const q = query(pubCol('messages'), where('chatId', '==', chatId));
            
            const c = document.getElementById('messages-container');
            c.innerHTML = '<div class="text-center text-white text-xs mt-10 opacity-70 bg-black/20 rounded-full py-1 px-3 w-max mx-auto">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...</div>';
            
            unsubscribeMsg = onSnapshot(q, (snap) => {
                const msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                // Sort locally
                msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                c.innerHTML = '';
                if(msgs.length === 0) {
                     c.innerHTML = '<div class="text-center bg-black bg-opacity-20 text-white rounded-full text-xs py-1 px-3 mx-auto w-max mt-10 backdrop-blur-sm">Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª. Ø³Ù„Ø§Ù… Ú©Ù†ÛŒØ¯! ğŸ‘‹</div>';
                     return; 
                }
                
                let lastSenderId = null;

                msgs.forEach(m => {
                    const me = m.senderId === currentUser.uid;
                    const sameSender = lastSenderId === m.senderId;
                    lastSenderId = m.senderId;

                    const div = document.createElement('div');
                    div.className = `flex w-full ${me ? 'justify-end' : 'justify-start'} animate-fade-in`;
                    
                    const time = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'}) : '...';

                    div.innerHTML = `
                        <div class="message-bubble relative p-2 px-3 rounded-2xl text-sm mb-1 min-w-[80px] group 
                        ${me ? 'bg-[#effdde] text-black rounded-br-sm' : 'bg-white text-black rounded-bl-sm'}">
                            ${!me && group && !sameSender ? `<div class="text-[11px] text-blue-600 font-bold mb-0.5">${m.senderName}</div>` : ''}
                            <div class="pb-1 leading-6 relative z-10" style="white-space: pre-wrap;">${m.text}</div>
                            <div class="text-[9px] ${me ? 'text-green-700' : 'text-gray-400'} text-left -mt-1 opacity-70 flex justify-end items-center gap-1">
                                ${time}
                                ${me ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                        </div>`;
                    c.appendChild(div);
                });
                // Scroll to bottom
                requestAnimationFrame(() => c.scrollTop = c.scrollHeight);
            });
        };

        window.closeChat = () => {
            document.getElementById('chat-area').classList.add('translate-x-full');
            document.getElementById('sidebar').classList.remove('hidden');
            currentChatId = null;
            if(unsubscribeMsg) unsubscribeMsg();
        };

        window.sendMessage = async () => {
            const i = document.getElementById('message-input');
            const txt = i.value.trim();
            if(!txt || !currentChatId) return;
            i.value = '';
            i.style.height = 'auto';

            try {
                const ts = serverTimestamp();
                
                // 1. Add Message
                await addDoc(pubCol('messages'), {
                    text: txt, 
                    senderId: currentUser.uid, 
                    senderName: userData.name, 
                    chatId: currentChatId, 
                    timestamp: ts
                });

                // 2. Update Chat Metadata (for sidebar)
                if(currentChatId !== 'global_public_group') {
                    const ids = currentChatId.split('_');
                    const chatRef = pubDoc('chats', currentChatId);
                    
                    const updateData = {
                        lastMessage: txt,
                        lastMessageTime: ts,
                        participantIds: ids,
                        type: 'private'
                    };
                    
                    updateData[`participantsData.${currentUser.uid}`] = {
                        name: userData.name,
                        photo: userData.photoURL
                    };

                    await setDoc(chatRef, updateData, {merge: true});
                }

            } catch(e) { console.error("Send Error", e); }
        };

        // --- 5. SEARCH & NEW CHAT (FIXED) ---
        let st;
        window.handleSearch = () => {
            clearTimeout(st);
            const v = document.getElementById('search-input').value.trim().toLowerCase();
            const r = document.getElementById('search-results');
            if(!v) { r.classList.add('hidden'); return; }
            
            st = setTimeout(async () => {
                // Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ùˆ Ø¨Ú¯ÛŒØ± Ùˆ Ø¯Ø± Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÙÛŒÙ„ØªØ± Ú©Ù†
                const snap = await getDocs(query(pubCol('users'), limit(50)));
                r.innerHTML = '';
                r.classList.remove('hidden');
                
                const users = [];
                snap.forEach(d => {
                    const u = d.data();
                    if(u.uid === currentUser.uid) return;
                    if(u.username.includes(v) || u.name.includes(v)) {
                        users.push(u);
                    }
                });
                
                if(users.length === 0) {
                     r.innerHTML = '<div class="p-3 text-center text-xs text-gray-500">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                }

                users.forEach(u => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center p-3 hover:bg-blue-100 cursor-pointer border-b border-blue-100 last:border-0 transition';
                    el.innerHTML = `
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full ml-3 object-cover">
                        <div>
                            <div class="text-sm font-bold text-gray-800">${u.name}</div>
                            <div class="text-xs text-gray-500">@${u.username}</div>
                        </div>
                    `;
                    el.onclick = async () => {
                        const chatId = [currentUser.uid, u.uid].sort().join('_');
                        
                        const chatRef = pubDoc('chats', chatId);
                        await setDoc(chatRef, {
                            participantIds: [currentUser.uid, u.uid],
                            participantsData: {
                                [currentUser.uid]: { name: userData.name, photo: userData.photoURL },
                                [u.uid]: { name: u.name, photo: u.photoURL }
                            },
                            type: 'private',
                            createdAt: serverTimestamp()
                        }, {merge: true});

                        openChat(chatId, u.name, u.photoURL, false);
                        r.classList.add('hidden');
                        document.getElementById('search-input').value = '';
                    };
                    r.appendChild(el);
                });
            }, 600);
        };

        // --- 6. MEMBERS & SETTINGS ---
        window.handleHeaderClick = async () => {
            if(!isGroup) return; 
            const m = document.getElementById('members-modal');
            const l = document.getElementById('members-list');
            m.classList.remove('hidden');
            l.innerHTML = '<div class="text-center mt-10 text-gray-400"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const snap = await getDocs(query(pubCol('users'), orderBy('createdAt', 'desc'), limit(50)));
                l.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    const isMe = u.uid === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = 'flex items-center p-2 hover:bg-gray-50 cursor-pointer rounded-xl mb-1 transition';
                    el.innerHTML = `
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full object-cover ml-3 border border-gray-100">
                        <div class="flex-1">
                            <div class="font-bold text-sm text-gray-800">${u.name} ${isMe ? '<span class="text-[10px] text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full mr-1">Ø®ÙˆØ¯Ù…</span>' : ''}</div>
                            <div class="text-xs text-gray-400">@${u.username}</div>
                        </div>
                        <div class="text-gray-300"><i class="fas fa-comment-alt"></i></div>
                    `;
                    if(!isMe) {
                        el.onclick = async () => {
                            m.classList.add('hidden');
                            const chatId = [currentUser.uid, u.uid].sort().join('_');
                            await setDoc(pubDoc('chats', chatId), {
                                participantIds: [currentUser.uid, u.uid],
                                participantsData: {
                                    [currentUser.uid]: { name: userData.name, photo: userData.photoURL },
                                    [u.uid]: { name: u.name, photo: u.photoURL }
                                },
                                type: 'private'
                            }, {merge: true});
                            openChat(chatId, u.name, u.photoURL, false);
                        };
                    }
                    l.appendChild(el);
                });
            } catch(e) { l.innerHTML = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª'; }
        };

        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.handleSetImage = (i) => processImage(i, (r) => { tempImg = r; document.getElementById('set-avatar').src = r; });
        
        window.saveSettings = async () => {
            const n = document.getElementById('set-name').value;
            if(!n) return;
            const btn = document.querySelector('#settings-modal button');
            btn.innerText = 'Ø¯Ø±Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
            await updateDoc(pubDoc('users', currentUser.uid), { name: n, photoURL: tempImg || userData.photoURL });
            userData.name = n; if(tempImg) userData.photoURL = tempImg;
            document.getElementById('settings-modal').classList.add('hidden');
            btn.innerText = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
            tempImg = null;
        };

        // Utils
        function processImage(input, cb) {
            if(input.files && input.files[0]) {
                const fr = new FileReader();
                fr.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        let w=img.width, h=img.height;
                        if(w>h && w>200){h*=200/w;w=200;} else if(h>200){w*=200/h;h=200;}
                        c.width=w; c.height=h;
                        ctx.drawImage(img,0,0,w,h);
                        cb(c.toDataURL('image/jpeg', 0.8));
                    }
                    img.src = e.target.result;
                };
                fr.readAsDataURL(input.files[0]);
            }
        }
        
        // Auto-resize textarea
        const tx = document.getElementById('message-input');
        tx.addEventListener("input", function(){
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

    </script>
</body>
    </html>
